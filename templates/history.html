{% extends "base.html" %} {% block title %}Screening History - AI Resume
Screener{% endblock %} {% block content %}
<div class="container py-5">
  <div class="row">
    <div class="col-lg-10 mx-auto">
      <h2 class="mb-4"><i class="fas fa-history"></i> Screening History</h2>

      <div id="historyContainer">
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mt-2">Loading history...</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  async function loadHistory() {
    try {
      const response = await fetch("/api/history?limit=50");
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Failed to load history");
      }

      displayHistory(data);
    } catch (error) {
      console.error("Error:", error);
      document.getElementById("historyContainer").innerHTML =
        `<div class="alert alert-danger">Error loading history: ${error.message}</div>`;
    }
  }

  function displayHistory(data) {
    const container = document.getElementById("historyContainer");

    if (!data || data.length === 0) {
      container.innerHTML =
        '<div class="alert alert-info">No screenings yet.</div>';
      return;
    }

    const html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Date</th>
                        <th>Resume File</th>
                        <th>Score</th>
                        <th>Rating</th>
                        <th>Similarity</th>
                        <th>Skill Match</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    ${data
                      .map(
                        (record, idx) => `
                        <tr>
                            <td><small>${new Date(record.created_at).toLocaleString()}</small></td>
                            <td><small>${record.resume_filename}</small></td>
                            <td><strong>${record.final_score.toFixed(1)}</strong></td>
                            <td>${record.rating}</td>
                            <td>${record.similarity_score.toFixed(1)}%</td>
                            <td>${record.skill_match_score.toFixed(1)}%</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewDetails(${record.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    `,
                      )
                      .join("")}
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
  }

  async function viewDetails(screeningId) {
    try {
      const response = await fetch(`/api/screening/${screeningId}`);
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Failed to load details");
      }

      // Parse skill_details if it's a JSON string
      if (typeof data.skill_details === "string") {
        data.skill_details = JSON.parse(data.skill_details);
      }

      showDetailModal(data);
    } catch (error) {
      console.error("Error:", error);
      alert("Error loading details: " + error.message);
    }
  }

  function showDetailModal(data) {
    const modalHtml = `
        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Screening Details</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Overall Score</h6>
                                <h3 class="text-primary">${data.final_score.toFixed(1)}</h3>
                            </div>
                            <div class="col-md-6">
                                <h6>Rating</h6>
                                <h3>${data.rating}</h3>
                            </div>
                        </div>
                        <hr>
                        <h6>Details</h6>
                        <p><strong>Similarity Score:</strong> ${data.similarity_score.toFixed(1)}%</p>
                        <p><strong>Skill Match Score:</strong> ${data.skill_match_score.toFixed(1)}%</p>
                        <hr>
                        <h6>Feedback</h6>
                        <pre class="feedback-text">${data.feedback}</pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById("detailModal");
    if (existingModal) existingModal.remove();

    document.body.insertAdjacentHTML("beforeend", modalHtml);

    const modal = new bootstrap.Modal(document.getElementById("detailModal"));
    modal.show();
  }

  // Load history on page load
  document.addEventListener("DOMContentLoaded", loadHistory);
</script>
{% endblock %}
